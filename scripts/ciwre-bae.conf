<VirtualHost *:443>
    ServerName ciwre-bae.campusad.msu.edu
    DocumentRoot /data/SWATGenXApp/codes/web_application/frontend/build
    <Directory /data/SWATGenXApp/codes/web_application/frontend/build>
        Require all granted
        AllowOverride All
        Options Indexes FollowSymLinks
    </Directory>

    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Ssl "on"

    # Proxy API Requests to Flask (port 5050)
    ProxyPreserveHost On
    ProxyRequests Off
    ProxyPass        /api/ http://127.0.0.1:5050/api/
    ProxyPassReverse /api/ http://127.0.0.1:5050/api/

    # Proxy WebSocket Requests (if needed)
    ProxyPass /ws ws://127.0.0.1:5050/ws
    ProxyPassReverse /ws ws://127.0.0.1:5050/ws

    # Proxy login requests
    ProxyPass /login http://127.0.0.1:5050/login
    ProxyPassReverse /login http://127.0.0.1:5050/login

    # Serve Reactâ€™s static files
    Alias /static/react /data/SWATGenXApp/codes/web_application/frontend/build/static
    <Directory /data/SWATGenXApp/codes/web_application/frontend/build/static>
        Require all granted
        Options Indexes FollowSymLinks
        AllowOverride None
    </Directory>

    # Legacy static files
    Alias /static/images /data/SWATGenXApp/GenXAppData/images
    <Directory /data/SWATGenXApp/GenXAppData/images>
        Require all granted
        Options Indexes FollowSymLinks
        AllowOverride None
        Header set Access-Control-Allow-Origin "*"
    </Directory>

    Alias /static/videos /data/SWATGenXApp/GenXAppData/videos
    <Directory /data/SWATGenXApp/GenXAppData/videos>
        Require all granted
        Options Indexes FollowSymLinks
        AllowOverride None
        Header set Access-Control-Allow-Origin "*"
    </Directory>

    # Allow access to user directories
    <Directory /data/SWATGenXApp/Users>
        Require all granted
    </Directory>

    # React frontend routing fallback
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteCond %{REQUEST_URI} !^/ws
    RewriteCond %{REQUEST_URI} !^/static/
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ /index.html [QSA,L]

    # SSL certificates
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/ciwre-bae_campusad_msu_edu_cert.cer
    SSLCertificateChainFile /etc/ssl/certs/ciwre-bae_campusad_msu_edu.cer
    SSLCertificateKeyFile /etc/ssl/private/ciwre-bae.campusad.msu.edu.key

    # Error and Access Logs
    ErrorLog /data/SWATGenXApp/codes/web_application/logs/ciwre-bae_error.log
    CustomLog /data/SWATGenXApp/codes/web_application/logs/ciwre-bae_access.log combined
</VirtualHost>
