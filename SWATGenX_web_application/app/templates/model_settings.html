{% extends "layout.html" %}

{% block title %}Model Settings{% endblock %}

{% block content %}
<h2 class="mb-4">Submit Your Model Settings</h2>
<div class="row">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <form method="post">
                    {{ form.hidden_tag() }}
                    
                    <!-- Search Site Name -->
                    <div class="form-group">
                        <label for="search_input">Search Site Name:</label>
                        {{ form.search_input(class="form-control", id="search_input", placeholder="Enter site name") }}
                        <button type="button" class="btn btn-secondary mt-2" id="search_button">Search</button>
                    </div>

                    <div id="search_results"></div>  <!-- Search results will be displayed here -->
                    
                    <!-- USGS Station Number (this will be updated based on search) -->
                    <div class="form-group">
                        <label for="user_input">USGS Station Number:</label>
                        {{ form.user_input(class="form-control", id="user_input", placeholder="Enter station number", list="station_list") }}
                        <datalist id="station_list">
                            {% for station in station_list %}
                                <option value="{{ station }}">
                            {% endfor %}
                        </datalist>
                    </div>

                    <div id="station_characteristics">
                        {% if station_characteristics %}
                            <h5>Station Characteristics:</h5>
                            <ul>
                                {% for characteristic in station_characteristics %}
                                    <li>{{ characteristic }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                    
                    <!-- Other form fields -->
                    <div class="form-group">
                        <label for="ls_resolution">Landuse/Soil Resolution:</label>
                        {{ form.ls_resolution(class="form-control", id="ls_resolution") }}
                    </div>
                    <div class="form-group">
                        <label for="dem_resolution">DEM Resolution:</label>
                        {{ form.dem_resolution(class="form-control", id="dem_resolution") }}
                    </div>

                    <!-- Calibration Settings -->
                    <div class="checkbox-container">
                        <div class="form-group form-check">
                            {{ form.calibration_flag(class="form-check-input", id="calibration_flag", onchange="toggleCalibration(this)") }}
                            <label class="form-check-label" for="calibration_flag">Calibration</label>
                        </div>
                        <div id="calibration_settings" class="settings-container" style="display: none;">
                            <div class="form-group">
                                <label for="max_iterations">Max Iterations:</label>
                                {{ form.max_iterations(class="form-control", id="max_iterations") }}
                            </div>
                            <div class="form-group">
                                <label for="cal_pool_size">Population Size:</label>
                                {{ form.cal_pool_size(class="form-control", id="cal_pool_size") }}
                            </div>
                        </div>
                    </div>

                    <!-- Sensitivity Settings -->
                    <div class="checkbox-container">
                        <div class="form-group form-check">
                            {{ form.sensitivity_flag(class="form-check-input", id="sensitivity_flag", onchange="toggleSensitivity(this)") }}
                            <label class="form-check-label" for="sensitivity_flag">Sensitivity</label>
                        </div>
                        <div id="sensitivity_settings" class="settings-container" style="display: none;">
                            <div class="form-group">
                                <label for="sen_pool_size">Pool Size:</label>
                                {{ form.sen_pool_size(class="form-control", id="sen_pool_size") }}
                            </div>
                            <div class="form-group">
                                <label for="sen_total_evaluations">Total Evaluations:</label>
                                {{ form.sen_total_evaluations(class="form-control", id="sen_total_evaluations") }}
                            </div>
                            <div class="form-group">
                                <label for="num_levels">Number of Levels:</label>
                                {{ form.num_levels(class="form-control", id="num_levels") }}
                            </div>
                        </div>
                    </div>

                    <!-- Validation Settings -->
                    <div class="checkbox-container">
                        <div class="form-group form-check">
                            {{ form.validation_flag(class="form-check-input", id="validation_flag", onchange="toggleValidation(this)") }}
                            <label class="form-check-label" for="validation_flag">Validation</label>
                        </div>
                        <div id="validation_settings" class="settings-container" style="display: none;">
                            <div class="form-group">
                                <label for="verification_samples">Samples:</label>
                                {{ form.verification_samples(class="form-control", id="verification_samples") }}
                            </div>
                        </div>
                    </div>
                    
                    {{ form.submit(class="btn btn-primary") }}
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div id="viewDiv" style="height: 500px;"></div>
    </div>
</div>

<script>
    function toggleCalibration(checkbox) {
        var calibrationSettings = document.getElementById("calibration_settings");
        calibrationSettings.style.display = checkbox.checked ? "flex" : "none";
    }

    function toggleSensitivity(checkbox) {
        var sensitivitySettings = document.getElementById("sensitivity_settings");
        sensitivitySettings.style.display = checkbox.checked ? "flex" : "none";
    }

    function toggleValidation(checkbox) {
        var validationSettings = document.getElementById("validation_settings");
        validationSettings.style.display = checkbox.checked ? "flex" : "none";
    }

    // Handle site search
    document.getElementById('search_button').addEventListener('click', function() {
        var searchTerm = document.getElementById('search_input').value;

        fetch('/search_site?search_term=' + searchTerm)
        .then(response => response.json())
        .then(data => {
            var resultsDiv = document.getElementById('search_results');
            if (data.error) {
                resultsDiv.innerHTML = `<p>${data.error}</p>`;
            } else {
                resultsDiv.innerHTML = '<ul>';
                data.forEach(site => {
                    resultsDiv.innerHTML += `<li>Site: ${site.SiteName} (Number: ${site.SiteNumber})</li>`;
                });
                resultsDiv.innerHTML += '</ul>';
            }
        })
        .catch(error => {
            console.error('Error fetching search results:', error);
        });
    });

    // JavaScript for Esri Map and Station Details
    require([
        "esri/Map",
        "esri/views/MapView",
        "esri/Graphic",
        "esri/layers/GraphicsLayer",
        "esri/geometry/Polygon",
        "esri/geometry/Polyline"
    ], function(Map, MapView, Graphic, GraphicsLayer, Polygon, Polyline) {
        var map = new Map({
            basemap: "topo-vector"
        });

        var view = new MapView({
            container: "viewDiv",
            map: map,
            zoom: 4,
            center: [-90, 38]
        });

        var graphicsLayer = new GraphicsLayer();
        map.add(graphicsLayer);

        window.view = view;

        $('#user_input').change(function() {
            var selectedStation = $(this).val();
            $.ajax({
                url: '/get_station_characteristics',
                type: 'GET',
                data: { station: selectedStation },
                success: function(response) {
                    var characteristicsHtml = "<h5>Station Characteristics:</h5><ul>";
                    for (var key in response) {
                        if (response.hasOwnProperty(key) && key !== 'geometries' && key !== 'flowlines') {
                            var value = response[key];
                            if (value !== null && value !== undefined && !(Array.isArray(value) && value.length === 0)) {
                                characteristicsHtml += "<li>" + key + ": " + value + "</li>";
                            }
                        }
                    }
                    characteristicsHtml += "</ul>";
                    $('#station_characteristics').html(characteristicsHtml);

                    var latitude = response['Latitude'];
                    var longitude = response['Longitude'];
                    view.goTo({
                        center: [longitude, latitude],
                        zoom: 10
                    });

                    var marker = new Graphic({
                        geometry: {
                            type: "point",
                            longitude: longitude,
                            latitude: latitude
                        },
                        symbol: {
                            type: "simple-marker",
                            color: [226, 119, 40],
                            outline: {
                                color: [255, 255, 255],
                                width: 2
                            }
                        }
                    });

                    view.graphics.removeAll();
                    view.graphics.add(marker);

                    if (response.geometries) {
                        graphicsLayer.removeAll();
                        response.geometries.forEach(function(geometry) {
                            var polygon = new Polygon({
                                rings: geometry.coordinates[0]
                            });

                            var polygonGraphic = new Graphic({
                                geometry: polygon,
                                symbol: {
                                    type: "simple-fill",
                                    color: [227, 139, 79, 0.8],
                                    outline: {
                                        color: [255, 255, 255],
                                        width: 1
                                    }
                                }
                            });
                            graphicsLayer.add(polygonGraphic);
                        });
                    }

                    if (response.flowlines) {
                        response.flowlines.forEach(function(flowline) {
                            var polyline = new Polyline({
                                paths: flowline.coordinates
                            });

                            var polylineGraphic = new Graphic({
                                geometry: polyline,
                                symbol: {
                                    type: "simple-line",
                                    color: [0, 0, 255],
                                    width: 2
                                }
                            });
                            graphicsLayer.add(polylineGraphic);
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching station details:', error);
                }
            });
        });
    });
</script>
{% endblock %}
