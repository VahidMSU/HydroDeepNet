{% extends "layout.html" %} {% block title %}Model Settings{% endblock %} {%
block content %}
<h2 class="mb-4">Submit Your Model Settings</h2>
<div class="row">
  <div class="col-lg-4">
    <div class="card">
      <div class="card-body">
        <form method="post" id="model_settings_form">
          {{ form.hidden_tag() }}

          <!-- Search Site Name -->
          <div class="form-group">
            <label for="search_input">Search Site Name:</label>
            {{ form.search_input(class_="form-control", id="search_input",
            placeholder="Enter site name") }}
            <button
              type="button"
              class="btn btn-secondary mt-2"
              id="search_button"
            >
              Search
            </button>
          </div>

          <div id="search_results"></div>
          <!-- Search results will be displayed here -->

          <!-- USGS Station Number -->
          <div class="form-group">
            <label for="user_input">USGS Station Number:</label>
            {{ form.user_input(class_="form-control", id="user_input",
            placeholder="Enter station number", list="station_list") }}
            <datalist id="station_list">
              {% for station in station_list %}
              <option value="{{ station }}">{% endfor %}</option>
            </datalist>
          </div>

          <div id="station_characteristics">
            {% if station_characteristics %}
            <h5>Station Characteristics:</h5>
            <ul>
              {% for characteristic in station_characteristics %}
              <li>{{ characteristic }}</li>
              {% endfor %}
            </ul>
            {% endif %}
          </div>

          <!-- Landuse/Soil Resolution -->
          <div class="form-group">
            <label for="ls_resolution">Landuse/Soil Resolution:</label>
            {{ form.ls_resolution(class_="form-control", id="ls_resolution") }}
          </div>

          <!-- DEM Resolution -->
          <div class="form-group">
            <label for="dem_resolution">DEM Resolution:</label>
            {{ form.dem_resolution(class_="form-control", id="dem_resolution")
            }}
          </div>

          <!-- Calibration Settings -->
          <div class="form-check">
            {{ form.calibration_flag(class_="form-check-input",
            id="calibration_flag", onchange="toggleSettings('calibration')") }}
            <label class="form-check-label" for="calibration_flag"
              >Calibration</label
            >
          </div>
          <div
            id="calibration_settings"
            class="settings-container"
            style="display: none"
          >
            <div class="form-group">
              <label for="max_iterations">Max Iterations:</label>
              {{ form.max_iterations(class_="form-control", id="max_iterations")
              }}
            </div>
            <div class="form-group">
              <label for="cal_pool_size">Population Size:</label>
              {{ form.cal_pool_size(class_="form-control", id="cal_pool_size")
              }}
            </div>
          </div>

          <!-- Sensitivity Settings -->
          <div class="form-check">
            {{ form.sensitivity_flag(class_="form-check-input",
            id="sensitivity_flag", onchange="toggleSettings('sensitivity')") }}
            <label class="form-check-label" for="sensitivity_flag"
              >Sensitivity</label
            >
          </div>
          <div
            id="sensitivity_settings"
            class="settings-container"
            style="display: none"
          >
            <div class="form-group">
              <label for="sen_pool_size">Pool Size:</label>
              {{ form.sen_pool_size(class_="form-control", id="sen_pool_size")
              }}
            </div>
            <div class="form-group">
              <label for="sen_total_evaluations">Total Evaluations:</label>
              {{ form.sen_total_evaluations(class_="form-control",
              id="sen_total_evaluations") }}
            </div>
            <div class="form-group">
              <label for="num_levels">Number of Levels:</label>
              {{ form.num_levels(class_="form-control", id="num_levels") }}
            </div>
          </div>

          <!-- Validation Settings -->
          <div class="form-check">
            {{ form.validation_flag(class_="form-check-input",
            id="validation_flag", onchange="toggleSettings('validation')") }}
            <label class="form-check-label" for="validation_flag"
              >Validation</label
            >
          </div>
          <div
            id="validation_settings"
            class="settings-container"
            style="display: none"
          >
            <div class="form-group">
              <label for="verification_samples">Samples:</label>
              {{ form.verification_samples(class_="form-control",
              id="verification_samples") }}
            </div>
          </div>

          <button type="button" class="btn btn-primary mt-3" id="submit_button">
            Run
          </button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div id="viewDiv" style="height: 500px; border: 1px solid #ccc"></div>
  </div>
</div>

<script>
  function toggleSettings(setting) {
    const settingsContainer = document.getElementById(`${setting}_settings`);
    const checkbox = document.getElementById(`${setting}_flag`);
    settingsContainer.style.display = checkbox.checked ? "block" : "none";
  }

  // Handle site search
  document
    .getElementById("search_button")
    .addEventListener("click", async function () {
      const searchTerm = document.getElementById("search_input").value;
      try {
        const response = await fetch(`/search_site?search_term=${searchTerm}`);
        const data = await response.json();
        const resultsDiv = document.getElementById("search_results");
        if (data.error) {
          resultsDiv.innerHTML = `<p>${data.error}</p>`;
        } else {
          resultsDiv.innerHTML =
            "<ul>" +
            data
              .map(
                (site) =>
                  `<li>Site: ${site.SiteName} (Number: ${site.SiteNumber})</li>`
              )
              .join("") +
            "</ul>";
        }
      } catch (error) {
        console.error("Error fetching search results:", error);
      }
    });

  // Handle form submission with confirmation
  document
    .getElementById("submit_button")
    .addEventListener("click", function () {
      if (confirm("Are you sure you want to submit these settings?")) {
        document.getElementById("model_settings_form").submit();
      }
    });

  // JavaScript for Esri Map and Station Details
  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/Graphic",
    "esri/layers/GraphicsLayer",
    "esri/geometry/Polygon",
    "esri/geometry/Polyline",
    "esri/widgets/LayerList",
    "esri/widgets/BasemapToggle",
    "esri/widgets/Search",
  ], function (
    Map,
    MapView,
    Graphic,
    GraphicsLayer,
    Polygon,
    Polyline,
    LayerList,
    BasemapToggle,
    Search
  ) {
    const map = new Map({ basemap: "topo-vector" });
    const view = new MapView({
      container: "viewDiv",
      map: map,
      zoom: 4,
      center: [-90, 38],
    });
    const graphicsLayer = new GraphicsLayer();
    map.add(graphicsLayer);
    window.view = view;

    // Add Layer List widget
    const layerList = new LayerList({ view: view });
    view.ui.add(layerList, "top-right");

    // Add Basemap Toggle widget
    const basemapToggle = new BasemapToggle({
      view: view,
      nextBasemap: "satellite",
    });
    view.ui.add(basemapToggle, "bottom-left");

    // Add Search widget
    const searchWidget = new Search({
      view: view,
    });
    view.ui.add(searchWidget, "top-left");

    document
      .getElementById("user_input")
      .addEventListener("change", async function () {
        const selectedStation = this.value;
        try {
          const response = await fetch(
            `/get_station_characteristics?station=${selectedStation}`
          );
          const data = await response.json();
          let characteristicsHtml = "<h5>Station Characteristics:</h5><ul>";
          for (const key in data) {
            if (
              data.hasOwnProperty(key) &&
              key !== "geometries" &&
              key !== "flowlines" &&
              data[key]
            ) {
              characteristicsHtml += `<li>${key}: ${data[key]}</li>`;
            }
          }
          characteristicsHtml += "</ul>";
          document.getElementById("station_characteristics").innerHTML =
            characteristicsHtml;

          if (data.Latitude && data.Longitude) {
            view.goTo({ center: [data.Longitude, data.Latitude], zoom: 10 });
            const marker = new Graphic({
              geometry: {
                type: "point",
                longitude: data.Longitude,
                latitude: data.Latitude,
              },
              symbol: {
                type: "simple-marker",
                color: [226, 119, 40],
                outline: { color: [255, 255, 255], width: 2 },
              },
            });
            view.graphics.removeAll();
            view.graphics.add(marker);
          }

          graphicsLayer.removeAll();
          if (data.geometries) {
            data.geometries.forEach((geometry) => {
              const polygon = new Polygon({ rings: geometry.coordinates[0] });
              const polygonGraphic = new Graphic({
                geometry: polygon,
                symbol: {
                  type: "simple-fill",
                  color: [227, 139, 79, 0.8],
                  outline: { color: [255, 255, 255], width: 1 },
                },
              });
              graphicsLayer.add(polygonGraphic);
            });
          }

          if (data.flowlines) {
            data.flowlines.forEach((flowline) => {
              const polyline = new Polyline({ paths: flowline.coordinates });
              const polylineGraphic = new Graphic({
                geometry: polyline,
                symbol: { type: "simple-line", color: [0, 0, 255], width: 2 },
              });
              graphicsLayer.add(polylineGraphic);
            });
          }
        } catch (error) {
          console.error("Error fetching station details:", error);
        }
      });
  });
</script>
{% endblock %}
