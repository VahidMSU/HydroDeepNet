{% extends "layout.html" %} {% block title %}Model Settings{% endblock %} {%
block content %}
<style>
  /* Map Container Styling */
  #viewDiv {
    width: 100%; /* Full width of its parent container */
    height: calc(
      100vh - 100px
    ); /* Increase height by reducing the margin adjustment */
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  /* Adjust height for smaller screens */
  @media (max-width: 768px) {
    #viewDiv {
      height: calc(80vh); /* Keep a large height for better interaction */
    }
  }

  /* Additional Layout Improvements */
  .container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .card {
    border-radius: 5px;
    box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }

  .card-body {
    padding: 10px;
  }

  .form-group label {
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
  }

  .form-control {
    border-radius: 5px;
    padding: 5px;
    font-size: 1rem;
  }

  button {
    border-radius: 5px;
  }

  /* Loading Indicator Styling */
  #loadingIndicator img {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* Ensure the parent row and column structure behaves properly */
  .row {
    display: flex;
    flex-wrap: wrap;
    gap: 20px; /* Add spacing between columns */
  }

  .col-lg-8 {
    flex: 1 1 60%; /* Allow the map column to grow dynamically */
    min-width: 300px; /* Ensure it doesnâ€™t shrink too small on smaller devices */
  }

  .col-lg-4 {
    flex: 1 1 35%; /* Allow the form column to grow dynamically */
    min-width: 300px;
  }

  /* Map Container Styling */
  #viewDiv {
    width: 100%; /* Full width of its column */
    height: calc(100vh - 150px); /* Adjust height dynamically */
    border: 1px solid #ccc;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  /* Fix layout issues for smaller screens */
  @media (max-width: 768px) {
    .row {
      flex-direction: column; /* Stack columns vertically on smaller screens */
    }

    #viewDiv {
      height: calc(50vh - 100px); /* Shrink map height for better usability */
    }
  }

  /* Form Elements Styling for Consistency */
  .form-group label {
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
  }

  .form-control {
    border-radius: 5px;
    padding: 10px;
    font-size: 1rem;
  }

  button {
    border-radius: 5px;
  }
</style>

<h2 class="mb-4">Create SWAT+ Models for USGS Streamgages Across CONUS</h2>
<div class="row">
  <div class="col-lg-4">
    <div class="card">
      <div class="card-body">
        <form method="post" id="model_settings_form">
          {{ form.hidden_tag() }}

          <!-- Search Site Name -->
          <div class="form-group">
            <label for="search_input">Search Site Name:</label>
            {{ form.search_input(class_="form-control", id="search_input",
            placeholder="Enter site name") }}
            <button
              type="button"
              class="btn btn-secondary mt-2"
              id="search_button"
            >
              Search
            </button>
          </div>

          <!-- Search results will be displayed here -->
          <div id="search_results"></div>
          <!-- Loading indicator (initially hidden) -->
          <div
            id="loadingIndicator"
            style="display: none; text-align: center; margin: 10px"
          >
            <img
              src="/static/images/spinner.gif"
              alt="Loading..."
              style="width: 40px"
            />
            <p>Loading, please wait...</p>
          </div>

          <!-- USGS Station Number -->
          <div class="form-group mt-3">
            <label for="user_input">USGS Station Number:</label>
            {{ form.user_input(class_="form-control", id="user_input",
            placeholder="Enter station number", list="station_list") }}
            <datalist id="station_list">
              {% for station in station_list %}
              <option value="{{ station }}"></option>
              {% endfor %}
            </datalist>
          </div>

          <div id="station_characteristics">
            {% if station_characteristics %}
            <h5>Station Characteristics:</h5>
            <ul>
              {% for characteristic in station_characteristics %}
              <li>{{ characteristic }}</li>
              {% endfor %}
            </ul>
            {% endif %}
          </div>

          <!-- Landuse/Soil Resolution -->
          <div class="form-group">
            <label for="ls_resolution">Landuse/Soil Resolution:</label>
            {{ form.ls_resolution(class_="form-control", id="ls_resolution") }}
          </div>

          <!-- DEM Resolution -->
          <div class="form-group">
            <label for="dem_resolution">DEM Resolution:</label>
            {{ form.dem_resolution(class_="form-control", id="dem_resolution")
            }}
          </div>

          <!-- Calibration, Sensitivity, Validation ... -->
          <!-- (Your existing calibration/sensitivity/validation form checks) -->

          <button type="button" class="btn btn-primary mt-3" id="submit_button">
            Run
          </button>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div id="viewDiv" style="height: 500px; border: 1px solid #ccc"></div>
  </div>
</div>

<!-- Helper function that sets station ID and dispatches the change event -->
<script>
  function selectStation(stationNumber) {
    const userInput = document.getElementById("user_input");
    userInput.value = stationNumber;
    // Force the 'change' event so geometry fetch code is triggered immediately
    userInput.dispatchEvent(new Event("change"));
  }
</script>

<script>
  // Toggles visibility of calibration, sensitivity, or validation panels
  document.getElementById("viewDiv").style.height = "900px";

  function toggleSettings(setting) {
    const settingsContainer = document.getElementById(`${setting}_settings`);
    const checkbox = document.getElementById(`${setting}_flag`);
    settingsContainer.style.display = checkbox.checked ? "block" : "none";
  }

  // JavaScript for Esri Map and Station Details
  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/Graphic",
    "esri/layers/GraphicsLayer",
    "esri/geometry/Polygon",
    "esri/geometry/Polyline",
    "esri/widgets/LayerList",
    "esri/widgets/BasemapToggle",
    "esri/widgets/Search",
  ], function (
    Map,
    MapView,
    Graphic,
    GraphicsLayer,
    Polygon,
    Polyline,
    LayerList,
    BasemapToggle,
    Search
  ) {
    // 1) Initialize map & view
    const map = new Map({ basemap: "topo-vector" });
    const view = new MapView({
      container: "viewDiv",
      map: map,
      zoom: 4,
      center: [-90, 38],
    });
    // 2) Create separate layers for polygons and streams
    const polygonLayer = new GraphicsLayer({ title: "HUC12 Polygons" });
    const streamLayer = new GraphicsLayer({ title: "Stream Polylines" });
    const lakeLayer = new GraphicsLayer({ title: "Lake Polygons" });
    // Optional: a separate marker layer if you want that toggled independently
    // const stationMarkerLayer = new GraphicsLayer({ title: "Station Marker" });

    // Add them to the map so each appears in the LayerList
    map.addMany([polygonLayer, streamLayer, lakeLayer]);
    // map.add(stationMarkerLayer); // if using a marker layer

    // 3) Add layer controls
    const layerList = new LayerList({ view: view });
    view.ui.add(layerList, "top-right");

    const basemapToggle = new BasemapToggle({
      view: view,
      nextBasemap: "satellite",
    });
    view.ui.add(basemapToggle, "bottom-left");

    const searchWidget = new Search({ view: view });
    view.ui.add(searchWidget, "top-left");

    // =========== (A) SEARCH BY SITE NAME ===========
    const searchButton = document.getElementById("search_button");
    searchButton.addEventListener("click", async function () {
      const searchTerm = document.getElementById("search_input").value.trim();
      showLoading(); // Show the loading indicator
      try {
        const response = await fetch(`/search_site?search_term=${searchTerm}`);
        const data = await response.json();

        const resultsDiv = document.getElementById("search_results");
        if (data.error) {
          resultsDiv.innerHTML = `<p>${data.error}</p>`;
        } else {
          // Show a clickable list of results
          let html = "<ul>";
          data.forEach((site) => {
            html += `
              <li style="cursor:pointer; color:blue"
                  onclick="selectStation('${site.SiteNumber}')">
                <strong>${site.SiteName}</strong> (Number: ${site.SiteNumber})
              </li>
            `;
          });
          html += "</ul>";
          resultsDiv.innerHTML = html;
        }
      } catch (error) {
        console.error("Error fetching search results:", error);
      } finally {
        hideLoading(); // Hide indicator when done (success or fail)
      }
    });
    // =========== (B) FETCH GEOMETRIES & CHARACTERISTICS BY STATION NUMBER ===========
    document
      .getElementById("user_input")
      .addEventListener("change", async function () {
        const selectedStation = this.value;
        showLoading(); // Show the loading indicator
        try {
          const response = await fetch(
            `/get_station_characteristics?station=${selectedStation}`
          );
          const data = await response.json();

          // Build station characteristics HTML
          let characteristicsHtml = "<h5>Station Characteristics:</h5><ul>";
          for (const key in data) {
            if (
              data.hasOwnProperty(key) &&
              key !== "geometries" &&
              key !== "streams_geometries" &&
              key !== "lakes_geometries" &&
              data[key]
            ) {
              characteristicsHtml += `<li>${key}: ${data[key]}</li>`;
            }
          }
          characteristicsHtml += "</ul>";
          document.getElementById("station_characteristics").innerHTML =
            characteristicsHtml;

          // Clear previous shapes
          polygonLayer.removeAll();
          streamLayer.removeAll();
          lakeLayer.removeAll();
          // If you have a station marker layer, also do: stationMarkerLayer.removeAll();

          // If lat/long exist, place a marker in view.graphics or a marker layer
          if (data.Latitude && data.Longitude) {
            // Zoom to station
            view.goTo({ center: [data.Longitude, data.Latitude], zoom: 10 });

            // Create a station marker
            const marker = new Graphic({
              geometry: {
                type: "point",
                longitude: data.Longitude,
                latitude: data.Latitude,
              },
              symbol: {
                type: "simple-marker",
                color: [226, 119, 40],
                outline: { color: [255, 255, 255], width: 2 },
              },
            });
            // Option 1: add it to the view's default graphics
            view.graphics.removeAll();
            view.graphics.add(marker);

            // Option 2: or put it on a separate layer so user can toggle it
            // stationMarkerLayer.add(marker);
          }

          // Draw polygons (HUC12 geometries) on polygonLayer
          if (data.geometries) {
            data.geometries.forEach((geom) => {
              const polygon = new Polygon({ rings: geom.coordinates[0] });
              const polygonGraphic = new Graphic({
                geometry: polygon,
                symbol: {
                  type: "simple-fill",
                  color: [227, 139, 79, 0.8], // fill color
                  outline: { color: [255, 255, 255], width: 1 },
                },
              });
              polygonLayer.add(polygonGraphic);
            });
          }
          // Draw polygons (lake geometries) on lakeLayer
          if (data.lakes_geometries) {
            data.lakes_geometries.forEach((lake) => {
              const polygon = new Polygon({ rings: lake.coordinates[0] });
              const polygonGraphic = new Graphic({
                geometry: polygon,
                symbol: {
                  type: "simple-fill",
                  color: [0, 0, 255, 0.5], // fill color
                  outline: { color: [255, 255, 255], width: 1 },
                },
              });
              lakeLayer.add(polygonGraphic);
            });
          }
          // Draw polylines (stream geometries) on streamLayer
          if (data.streams_geometries) {
            data.streams_geometries.forEach((stream) => {
              const polyline = new Polyline({ paths: stream.coordinates });
              const polylineGraphic = new Graphic({
                geometry: polyline,
                symbol: {
                  type: "simple-line",
                  color: [0, 0, 255],
                  width: 0.5,
                },
              });
              streamLayer.add(polylineGraphic);
            });
          }
        } catch (error) {
          console.error("Error fetching station details:", error);
        } finally {
          hideLoading(); // Hide indicator when done (success or fail)
        }
      });

    // =========== (C) HANDLE RUN BUTTON ===========
    document
      .getElementById("submit_button")
      .addEventListener("click", function () {
        if (confirm("Are you sure you want to submit these settings?")) {
          document.getElementById("model_settings_form").submit();
        }
      });
  });
  function showLoading() {
    const loadingDiv = document.getElementById("loadingIndicator");
    if (loadingDiv) {
      loadingDiv.style.display = "block";
    }
  }

  function hideLoading() {
    const loadingDiv = document.getElementById("loadingIndicator");
    if (loadingDiv) {
      loadingDiv.style.display = "none";
    }
  }
</script>
{% endblock %}
